# CMA scoring in GSE14520 (GPL3921)

# Packages
library(GEOquery)
library(matrixStats)
library(stringr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(pheatmap)
library(readxl)
library(survival)
library(survminer)

# CMA gene sets 
CMA_GENES <- list(
  effector  = c("LAMP2","HSPA8","HSP90AA1","HSP90AB1","DNAJB1"),
  lysosomal = c("GFAP","EEF1A1","PHLPP1","RAC1","RICTOR","AKT1","AKT2","CTSA"),
  extra     = c("NFATC1","NCOR1","NFE2L2","RAB11A","RARA")
)
CMA_GENE_ORDER <- unlist(CMA_GENES, use.names = FALSE)

# Demographics table (used for tumor size, sex, and survival)
demo <- read_excel(
  "data/GSE14520_Extra_Supplement_patients_demographics.xlsx",
  col_types = "text"
)

# Non-tumor vs tumor CMA score

# Load GEO series GSE14520 and pull GPL3921
GSE14520 <- getGEO("GSE14520", GSEMatrix = TRUE, AnnotGPL = TRUE)
eset     <- GSE14520[[grep("GPL3921", names(GSE14520))]]

# Phenotype info
pheno <- pData(eset)

# Collapse characteristics/source/title into one text field per sample
ph_txt <- apply(
  pheno[, grep("characteristics|source_name|title",
               colnames(pheno),
               ignore.case = TRUE),
        drop = FALSE],
  1,
  function(x) paste(na.omit(x), collapse = "; ")
)

# Rough annotation: non-tumor vs tumor
grp <- ifelse(
  grepl("non[ -]?tumou?r|non[ -]?tumor|adjacent|noncancer|non cancer|normal",
        ph_txt,
        ignore.case = TRUE),
  "Control",
  ifelse(grepl("tumou?r", ph_txt, ignore.case = TRUE), "HCC", NA)
)

names(grp) <- rownames(pheno)

# Quick sanity check + drop unclassified samples
table(grp, useNA = "ifany")
sel   <- !is.na(grp)
grp   <- grp[sel]
pheno <- pheno[sel, , drop = FALSE]
eset  <- eset[, sel]

# Expression matrix + feature annotation (filtered)
exprs_mat     <- exprs(eset)
feature_annot <- fData(eset)

# Use gene symbols for collapsing probes
symbol_col   <- "Gene symbol"
gene_symbols <- feature_annot[[symbol_col]]
gene_symbols <- ifelse(is.na(gene_symbols), "", gene_symbols)
gene_symbols <- sapply(
  strsplit(gene_symbols, "///|;|\\s?//\\s?|\\|"),
  function(x) trimws(x[1])
)

# Keep reasonably annotated probes
valid_idx    <- !(is.na(gene_symbols) |
                  gene_symbols == ""  |
                  gene_symbols %in% c("---", "—", "-"))
exprs_valid  <- exprs_mat[valid_idx, , drop = FALSE]
gene_symbols <- gene_symbols[valid_idx]

stopifnot(nrow(exprs_valid) == length(gene_symbols))

# Collapse probes to gene-level (median)
exprs_df              <- as.data.frame(exprs_valid)
exprs_df$Gene         <- gene_symbols
exprs_genelevel       <- aggregate(. ~ Gene, data = exprs_df, FUN = median)
rownames(exprs_genelevel) <- exprs_genelevel$Gene
exprs_genelevel$Gene       <- NULL
exprs_genelevel            <- as.matrix(exprs_genelevel)

# Make sure columns follow the filtered sample order
exprs_genelevel <- exprs_genelevel[, names(grp)]
stopifnot(identical(colnames(exprs_genelevel), names(grp)))

group <- factor(grp, levels = c("Control", "HCC"))
table(group)

# CMA machinery panel (direction and weight)
cma_panel <- data.frame(
  Gene      = c("LAMP2","HSPA8","HSP90AA1","HSP90AB1","DNAJB1",
                "GFAP","EEF1A1","PHLPP1","RAC1",
                "RICTOR","AKT1","AKT2","CTSA",
                "NFATC1","NCOR1","NFE2L2","RAB11A","RARA"),
  Direction = c( 1, 1, 1, 1, 1,
                 1, 1, 1, 1,
                -1,-1,-1,-1,
                 1, 1, 1, 1,-1),
  Weight    = c(2, rep(1, 17))
)

# Keep only genes actually present once, and reuse
present_genes <- intersect(cma_panel$Gene, rownames(exprs_genelevel))
cma_panel_use <- dplyr::filter(cma_panel, Gene %in% present_genes)

exprs_cma <- exprs_genelevel[cma_panel_use$Gene, ]

# Standardize CMA gene expression (per gene) then apply direction/weights
exprs_cma_z   <- t(scale(t(exprs_cma)))
exprs_cma_adj <- sweep(exprs_cma_z, 1, cma_panel_use$Direction, `*`)
exprs_cma_adj <- sweep(exprs_cma_adj, 1, cma_panel_use$Weight,    `*`)

# Collapse to a single CMA score per sample
total_weight <- sum(cma_panel_use$Weight)
cma_score    <- colSums(exprs_cma_adj, na.rm = TRUE) / total_weight

cma_df <- data.frame(
  Sample    = colnames(exprs_cma_adj),
  Group     = factor(grp, levels = c("Control", "HCC")),
  CMA_score = as.numeric(cma_score)
)

wilcox.test(CMA_score ~ Group, data = cma_df, exact = FALSE)

ggplot(cma_df, aes(x = Group, y = CMA_score, fill = Group)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.15, alpha = 0.5, size = 1.3) +
  labs(y = "CMA score (weighted z)", title = "CMA score: HCC vs Control") +
  theme_classic() +
  guides(fill = "none")

# Save ordered table (useful for Prism)
cma_df_ordered <- cma_df[order(cma_df$Group), ]
write.csv(cma_df_ordered,
          "CMA_scores_HCC_vs_Control_ordered.csv",
          row.names = FALSE)

# Fixed gene ordering for heatmap
gene_order      <- intersect(CMA_GENE_ORDER, rownames(exprs_cma_z))
exprs_cma_z_hm  <- exprs_cma_z[gene_order, , drop = FALSE]

# Order samples by group for plotting
ord             <- order(group)
exprs_cma_z_hm  <- exprs_cma_z_hm[, ord, drop = FALSE]
group_ord       <- droplevels(group[ord])

ann_col <- data.frame(Group = group_ord,
                      row.names = colnames(exprs_cma_z_hm))

pheatmap(
  exprs_cma_z_hm,
  cluster_rows   = FALSE,
  cluster_cols   = FALSE,
  annotation_col = ann_col,
  show_colnames  = FALSE,
  main           = "CMA genes (effectors \u2192 lysosomal \u2192 extra-lysosomal)"
)

write.csv(exprs_cma_z_hm,
          "CMA_heatmap_values_for_Prism.csv",
          row.names = TRUE)


# CMA vs tumor size (Control / small / large) 

demo_clean <- demo %>%
  transmute(
    GSM           = as.character(`Affy_GSM`),
    TumorSize_raw = tolower(`Main Tumor Size (>/<=5 cm)`),
    TumorSize     = case_when(
      TumorSize_raw %in% c("small", "<=5 cm", "<=5cm", "≤5cm") ~ "small",
      TumorSize_raw %in% c("large", ">5 cm", ">5cm")           ~ "large",
      TRUE                                                     ~ NA_character_
    )
  )

gsm_ids  <- colnames(exprs_genelevel)
size_map <- demo_clean$TumorSize[match(gsm_ids, demo_clean$GSM)]

# Three-way grouping: non-tumor, small HCC, large HCC
group3 <- ifelse(group == "Control", "Control",
                 ifelse(size_map == "small", "Small",
                        ifelse(size_map == "large", "Large", NA)))

table(group3, useNA = "ifany")

exprs_cma   <- exprs_genelevel[cma_panel_use$Gene, ]
exprs_cma_z <- t(scale(t(exprs_cma)))
exprs_cma_adj <- sweep(exprs_cma_z, 1, cma_panel_use$Direction, `*`)
exprs_cma_adj <- sweep(exprs_cma_adj, 1, cma_panel_use$Weight,    `*`)

total_weight <- sum(cma_panel_use$Weight)
cma_score3   <- colSums(exprs_cma_adj, na.rm = TRUE) / total_weight

cma_df3 <- data.frame(
  Sample    = colnames(exprs_cma_adj),
  Group     = factor(group3, levels = c("Control","Small","Large")),
  CMA_score = as.numeric(cma_score3)
)
cma_df3 <- subset(cma_df3, !is.na(Group))

# Order samples by group for heatmap
ord             <- order(cma_df3$Group)
exprs_cma_z_ord <- exprs_cma_z[, cma_df3$Sample[ord], drop = FALSE]

gene_order_size <- intersect(CMA_GENE_ORDER, rownames(exprs_cma_z_ord))
exprs_cma_z_ord <- exprs_cma_z_ord[gene_order_size, , drop = FALSE]

ann_col_size <- data.frame(
  Group = cma_df3$Group[ord],
  row.names = colnames(exprs_cma_z_ord)
)

pheatmap(
  exprs_cma_z_ord,
  cluster_rows   = FALSE,
  cluster_cols   = FALSE,
  annotation_col = ann_col_size,
  show_colnames  = FALSE,
  main = "CMA genes by tumor size (Control / Small ≤5cm / Large >5cm)"
)

write.csv(cma_df3[order(cma_df3$Group), ],
          "CMA_scores_Control_Small_Large.csv",
          row.names = FALSE)

write.csv(exprs_cma_z_ord,
          "CMA_heatmap_values_Control_Small_Large.csv",
          row.names = TRUE)

# LAMP2 / STAG2 expression in Control vs Small tumors

# Keep probe-level matrix aligned with gene-level samples
exprs_valid <- exprs_valid[, colnames(exprs_genelevel)]
stopifnot(identical(colnames(exprs_valid), colnames(exprs_genelevel)))

lamp2_probes <- c("200821_at", "203042_at")
stag2_probes <- c("207983_s_at", "209022_at", "209023_s_at")

collapse_probes <- function(probes) {
  present <- probes[probes %in% rownames(exprs_valid)]
  if (length(present) == 0) return(NULL)
  expr_mat <- exprs_valid[present, , drop = FALSE]
  colMedians(expr_mat, na.rm = TRUE)
}

lamp2_vals <- collapse_probes(lamp2_probes)
stag2_vals <- collapse_probes(stag2_probes)

gene_df <- data.frame(
  Sample = colnames(exprs_valid),
  Group3 = group3,
  LAMP2  = lamp2_vals,
  STAG2  = stag2_vals
)

gene_df2 <- subset(gene_df, Group3 %in% c("Control", "Small"))
gene_df2$Group3 <- factor(gene_df2$Group3, levels = c("Control", "Small"))

ord      <- order(gene_df2$Group3)
gene_df2 <- gene_df2[ord, ]

wilcox.test(LAMP2 ~ Group3, data = gene_df2)
wilcox.test(STAG2 ~ Group3, data = gene_df2)

gene_df2_long <- tidyr::pivot_longer(
  gene_df2,
  cols      = c(LAMP2, STAG2),
  names_to  = "Gene",
  values_to = "Expression"
)

ggplot(gene_df2_long, aes(x = Group3, y = Expression, fill = Group3)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.15, alpha = 0.5, size = 1.2) +
  facet_wrap(~Gene, scales = "free_y") +
  labs(y = "log2 expression (median probes)",
       title = "Control vs Small HCC (LAMP2, STAG2)") +
  theme_classic(base_size = 12) +
  guides(fill = "none")

# Normalize to non-tumor mean (Δlog2 and linear fold change)
for (g in c("LAMP2", "STAG2")) {
  ctrl_mean <- mean(gene_df2[[g]][gene_df2$Group3 == "Control"], na.rm = TRUE)
  gene_df2[[paste0(g, "_log2FC")]]     <- gene_df2[[g]] - ctrl_mean
  gene_df2[[paste0(g, "_foldchange")]] <- 2^(gene_df2[[paste0(g, "_log2FC")]])
}

write.csv(gene_df2,
          "STAG2_LAMP2_Control_vs_Small_FC.csv",
          row.names = FALSE)


# Sex-stratified CMA scores 

lcs2sex <- demo %>%
  transmute(
    LCS = paste0("LCS_", str_extract(`LCS ID`, "\\d+")),
    Sex = toupper(Gender)  # "M" / "F"
  )

txtcols <- grep("characteristics|source_name|title",
                colnames(pheno),
                ignore.case = TRUE,
                value = TRUE)

ph_txt <- apply(
  pheno[, txtcols, drop = FALSE],
  1,
  function(x) paste(na.omit(x), collapse = "; ")
)

lcs_token <- stringr::str_extract(ph_txt, "LCS[ _-]?\\d+[A-B]?")
lcs_norm  <- ifelse(is.na(lcs_token),
                    NA,
                    paste0("LCS_", stringr::str_extract(lcs_token, "\\d+")))

sex_map <- lcs2sex$Sex[match(lcs_norm, lcs2sex$LCS)]
table(sex_map, useNA = "ifany")

group_sex_full <- dplyr::case_when(
  group == "Control" & sex_map == "F" ~ "Control_F",
  group == "Control" & sex_map == "M" ~ "Control_M",
  group == "HCC"     & sex_map == "F" ~ "HCC_F",
  group == "HCC"     & sex_map == "M" ~ "HCC_M")

table(group_sex_full, useNA = "ifany")

exprs_cma     <- exprs_genelevel[cma_panel_use$Gene, ]
exprs_cma_z   <- t(scale(t(exprs_cma)))
exprs_cma_adj <- sweep(sweep(exprs_cma_z, 1, cma_panel_use$Direction, `*`),
                       1, cma_panel_use$Weight, `*`)
cma_score_all <- colSums(exprs_cma_adj, na.rm = TRUE) /
  sum(cma_panel_use$Weight)

row_order <- intersect(CMA_GENE_ORDER, rownames(exprs_cma_z))

# Females

female_idx <- group_sex_full %in% c("Control_F","HCC_F")
grp_f      <- factor(group_sex_full[female_idx],
                     levels = c("Control_F","HCC_F"))

cma_df_f <- data.frame(
  Sample    = colnames(exprs_cma_adj)[female_idx],
  Group     = grp_f,
  CMA_score = cma_score_all[female_idx]
)

wilcox.test(CMA_score ~ Group, data = cma_df_f, exact = FALSE)

ggplot(cma_df_f, aes(Group, CMA_score, fill = Group)) +
  geom_boxplot(outlier.shape = NA, width = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.5) +
  stat_summary(fun = mean, geom = "point",
               shape = 23, size = 3, fill = "white") +
  labs(title = "CMA score: Female HCC vs Female Control",
       y = "CMA score (weighted z)", x = NULL) +
  theme_classic(base_size = 12) +
  theme(legend.position = "none")

exprs_f <- exprs_cma_z[row_order, female_idx, drop = FALSE][, order(grp_f), drop = FALSE]
ann_f   <- data.frame(Group = grp_f[order(grp_f)],
                      row.names = colnames(exprs_f))

pheatmap(exprs_f,
         cluster_rows   = FALSE,
         cluster_cols   = FALSE,
         annotation_col = ann_f,
         show_colnames  = FALSE,
         main = "CMA genes: Female Control vs Female HCC")

write.csv(cma_df_f[order(cma_df_f$Group), ],
          "CMA_scores_Female_Control_vs_HCC.csv",
          row.names = FALSE)
write.csv(exprs_f,
          "CMA_heatmap_values_Female_Control_vs_HCC.csv",
          row.names = TRUE)

# Males

male_idx <- group_sex_full %in% c("Control_M","HCC_M")
grp_m    <- factor(group_sex_full[male_idx],
                   levels = c("Control_M","HCC_M"))

cma_df_m <- data.frame(
  Sample    = colnames(exprs_cma_adj)[male_idx],
  Group     = grp_m,
  CMA_score = cma_score_all[male_idx]
)

wilcox.test(CMA_score ~ Group, data = cma_df_m, exact = FALSE)

ggplot(cma_df_m, aes(Group, CMA_score, fill = Group)) +
  geom_boxplot(outlier.shape = NA, width = 0.6) +
  geom_jitter(width = 0.15, alpha = 0.6, size = 1.5) +
  stat_summary(fun = mean, geom = "point",
               shape = 23, size = 3, fill = "white") +
  labs(title = "CMA score: Male HCC vs Male Control",
       y = "CMA score (weighted z)", x = NULL) +
  theme_classic(base_size = 12) +
  theme(legend.position = "none")

exprs_m <- exprs_cma_z[row_order, male_idx, drop = FALSE][, order(grp_m), drop = FALSE]
ann_m   <- data.frame(Group = grp_m[order(grp_m)],
                      row.names = colnames(exprs_m))

pheatmap(exprs_m,
         cluster_rows   = FALSE,
         cluster_cols   = FALSE,
         annotation_col = ann_m,
         show_colnames  = FALSE,
         main = "CMA genes: Male Control vs Male HCC")

write.csv(cma_df_m[order(cma_df_m$Group), ],
          "CMA_scores_Male_Control_vs_HCC.csv",
          row.names = FALSE)
write.csv(exprs_m,
          "CMA_heatmap_values_Male_Control_vs_HCC.csv",
          row.names = TRUE)


# Overall survival vs CMA 

samples <- colnames(exprs_genelevel)
is_hcc  <- group == "HCC"

time_os  <- as.numeric(demo$`Survival months`[match(samples, demo$`Affy_GSM`)])
event_os <- as.numeric(demo$`Survival status`[match(samples, demo$`Affy_GSM`)])

stopifnot(exists("cma_df"))

os_hcc <- data.frame(
  Sample      = samples[is_hcc],
  time_months = time_os[is_hcc],
  event       = event_os[is_hcc],
  CMA_score   = cma_df$CMA_score[match(samples[is_hcc], cma_df$Sample)]
) |>
  na.omit()

cut_hcc <- median(os_hcc$CMA_score, na.rm = TRUE)

km_df <- os_hcc |>
  mutate(CMA = factor(ifelse(CMA_score >= cut_hcc, "High", "Low"),
                      levels = c("Low","High"))) |>
  select(Time = time_months, Event = event, CMA)

fit <- survfit(Surv(Time, Event) ~ CMA, data = km_df)

ggsurvplot(fit, data = km_df,
           risk.table = TRUE, pval = TRUE, conf.int = TRUE,
           legend.labs = c("Low CMA","High CMA"),
           xlab = "Months", ylab = "Survival probability",
           title = "Overall survival by CMA (median split, HCC only)")

print(summary(coxph(Surv(Time, Event) ~ CMA, data = km_df)))

prism_threecol <- km_df %>%
  transmute(
    Months     = Time,
    `Low CMA`  = ifelse(CMA == "Low",  Event, NA),
    `High CMA` = ifelse(CMA == "High", Event, NA)
  ) %>%
  arrange(Months)

write.csv(prism_threecol,
          "Prism_OS_threecol.csv",
          row.names = FALSE,
          na = "")

# Small tumors only

stopifnot(exists("group3"), exists("cma_df3"))

is_small <- group3 == "Small"

os_small <- data.frame(
  Sample      = samples[is_small],
  time_months = time_os[is_small],
  event       = event_os[is_small],
  CMA_score   = cma_df3$CMA_score[match(samples[is_small], cma_df3$Sample)]
) |>
  na.omit()

cut_small <- median(os_small$CMA_score, na.rm = TRUE)

km_df_small <- os_small |>
  mutate(CMA = factor(ifelse(CMA_score >= cut_small, "High", "Low"),
                      levels = c("Low","High"))) |>
  select(Time = time_months, Event = event, CMA)

fit_small <- survfit(Surv(Time, Event) ~ CMA, data = km_df_small)

ggsurvplot(fit_small, data = km_df_small,
           risk.table = TRUE, pval = TRUE, conf.int = TRUE,
           legend.labs = c("Low CMA","High CMA"),
           xlab = "Months", ylab = "Overall survival probability",
           title = "Overall survival in SMALL HCC by CMA (median split)")

print(summary(coxph(Surv(Time, Event) ~ CMA, data = km_df_small)))

prism_threecol_small <- km_df_small %>%
  transmute(
    Months     = Time,
    `Low CMA`  = ifelse(CMA == "Low",  Event, NA),
    `High CMA` = ifelse(CMA == "High", Event, NA)
  ) %>%
  arrange(Months)

write.csv(prism_threecol_small,
          "Prism_OS_threecol_SMALL.csv",
          row.names = FALSE,
          na = "")



